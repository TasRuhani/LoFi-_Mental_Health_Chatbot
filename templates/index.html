<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mental Health Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/static/assets/favicon.ico" type="image/x-icon">
    <!-- Style for the backgrounds -->
    <style>
        .chat-bg {
            background-image: radial-gradient(circle at center, rgba(17, 24, 39, 0.2), rgba(17, 24, 39, 1)), url('/static/assets/doodle.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
        }

        #sidebar {
            background-size: cover;
            background-position: center;
            transition: background-image 1.5s ease-in-out;
            border-right: 1px solid rgba(72, 211, 236, 0.2);
            box-shadow: 4px 0px 15px -3px rgba(72, 230, 236, 0.3);
        }

        #breathing-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            position: relative;
            background-color: rgba(72, 230, 236, 0.3);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(72, 230, 236, 0.4);
            }

            21% {
                transform: scale(1.5);
                box-shadow: 0 0 20px 10px rgba(72, 230, 236, 0);
            }

            58% {
                transform: scale(1.5);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(72, 230, 236, 0.4);
            }
        }

        .breathing {
            animation: pulse 19s infinite ease-in-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble {
            animation: fadeInUp 0.5s ease-out;
        }
    </style>
</head>

<body class="dark:bg-gray-900 dark:text-white bg-gray-100 text-gray-900 h-screen flex flex-col">

    <!-- Main content area that holds sidebar and chat -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Sidebar: Hidden on mobile, slides in. Always visible on desktop. -->
        <div id="sidebar"
            class="fixed z-30 inset-y-0 left-0 w-3/4 sm:w-3/4 md:w-1/3 lg:w-1/4 shadow-md h-full transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out overflow-y-auto">
            <!-- Overlay to keep text readable -->
            <div class="absolute inset-0 bg-gray-800 bg-opacity-60"></div>
            <!-- Container with responsive padding -->
            <div class="relative flex flex-col items-center justify-between p-4 md:p-8 min-h-full">

                <!-- Top Section: Lofi Player -->
                <div class="text-center w-full">
                    <img src="/static/assets/lofi_girl.gif" alt="Lofi Girl"
                        class="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover shadow-lg border-4 border-pink-400 dark:border-pink-300 mb-4 mx-auto" />
                    <audio id="audio-player" loop></audio>
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-5 py-2 w-full max-w-xs mx-auto">
                            <button onclick="setTrack('mellow')"
                                class="bg-purple-500 text-white py-2 px-4 sm:px-10 rounded hover:bg-purple-600">Mellow</button>
                            <button onclick="setTrack('chill')"
                                class="bg-blue-500 text-white py-2 px-4 sm:px-10 rounded hover:bg-blue-600">Chill</button>
                            <button onclick="setTrack('happy')"
                                class="bg-yellow-500 text-white py-2 px-4 sm:px-10 rounded hover:bg-yellow-600">Happy</button>
                        </div>
                        <button onclick="togglePlay()"
                            class="bg-pink-500 text-white px-6 py-2 rounded shadow hover:bg-pink-600 transition">
                            Play / Pause
                        </button>
                    </div>
                </div>

                <!-- Bottom Section: Breathing Exercise -->
                <div class="text-center mt-8 md:mt-0">
                    <div id="breathing-container" class="mx-auto my-6 rounded-full overflow-hidden">
                        <img id="breathing-gif" src="/static/assets/cat.gif" alt="Breathing cat"
                            class="w-full h-full object-cover">
                    </div>
                    <p id="breathing-text" class="text-sm text-gray-300 h-4 mt-2"></p>
                    <button id="breathing-button" onclick="toggleBreathingExercise()"
                        class="mt-3 bg-cyan-700 text-white px-6 py-2 rounded shadow hover:bg-cyan-800 transition text-sm">
                        Start 4-7-8 Breathing
                    </button>
                </div>

            </div>
        </div>

        <!-- Overlay for mobile when sidebar is open -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Main Content: Chat Area -->
        <div class="flex-1 h-full flex flex-col p-4 md:p-6 space-y-4 chat-bg">
            <!-- Header -->
            <div class="flex justify-between items-center border-b border-gray-700 pb-2 flex-shrink-0">
                <div class="flex items-center">
                    <!-- Burger Menu Button (Mobile Only) -->
                    <button id="burger-menu" class="md:hidden text-white mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16m4 6H4">
                            </path>
                        </svg>
                    </button>
                    <!-- Logo and Title -->
                    <img src="/static/assets/logo.png" alt="Logo" class="h-8 w-8 mr-3">
                    <h1
                        class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent hidden md:block">
                        Lo-Fi Mental Health Chatbot</h1>
                </div>
                <button onclick="newChat()"
                    class="bg-blue-500 text-white px-4 py-1 rounded shadow hover:bg-blue-900 transition text-sm flex-shrink-0">
                    New Chat
                </button>
            </div>
            <!-- Chat Box -->
            <div id="chat-box" class="flex flex-col space-y-4 overflow-y-auto flex-1"></div>

            <!-- Input area -->
            <div
                class="flex items-center p-1 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800 w-full flex-shrink-0">
                <input id="chat-input" type="text" placeholder="Say something..."
                    class="flex-grow bg-transparent focus:outline-none p-3" />
                <button onclick="sendMessage()"
                    class="ml-2 p-2 text-pink-500 hover:text-pink-400 rounded-full hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="feather feather-send">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <!-- Script -->
    <script>
        const audio = document.getElementById("audio-player");
        let musicRecommended = false;
        let mainBreathingLoop = null;
        let countdownInterval = null;

        function togglePlay() {
            if (audio.paused) audio.play();
            else audio.pause();
        }

        function setTrack(mood) {
            const tracks = {
                chill: "/static/assets/chill.mp3",
                mellow: "/static/assets/mellow.mp3",
                happy: "/static/assets/happy.mp3"
            };
            if (tracks[mood]) {
                audio.src = tracks[mood];
                audio.play();
            }
        }

        function newChat() {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = '';
            musicRecommended = false;
            showGreeting();
        }

        function showGreeting() {
            const chatBox = document.getElementById("chat-box");
            const greeting = document.createElement("div");
            greeting.className = "self-start bg-cyan-700 text-white p-3 rounded-lg max-w-md message-bubble";
            greeting.textContent = "Hey! How are you feeling today?";
            chatBox.appendChild(greeting);
        }

        async function sendMessage() {
            const input = document.getElementById("chat-input");
            const chatBox = document.getElementById("chat-box");
            const message = input.value.trim();
            if (!message) return;

            const userBubble = document.createElement("div");
            userBubble.className = "self-end bg-blue-500 text-white p-3 rounded-lg max-w-md message-bubble";
            userBubble.textContent = message;
            chatBox.appendChild(userBubble);
            input.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message, music_recommended: musicRecommended })
                });
                const data = await res.json();
                const botBubble = document.createElement("div");
                botBubble.className = "self-start bg-cyan-700 text-white p-3 rounded-lg max-w-md whitespace-pre-line message-bubble";
                botBubble.textContent = data.reply;
                chatBox.appendChild(botBubble);
                chatBox.scrollTop = chatBox.scrollHeight;

                if (data.mood) {
                    musicRecommended = true;
                    setTimeout(() => {
                        const musicBubble = document.createElement("div");
                        musicBubble.className = "self-start bg-pink-500 text-white p-3 rounded-lg max-w-md message-bubble";
                        musicBubble.innerHTML = `ðŸŽ§ You might enjoy some <i>${data.mood}</i> vibes right now.`;
                        chatBox.appendChild(musicBubble);
                        chatBox.scrollTop = chatBox.scrollHeight;
                        setTrack(data.mood);
                    }, 700);
                }
            } catch (err) {
                const errorBubble = document.createElement("div");
                errorBubble.className = "self-start bg-red-400 text-white p-3 rounded-lg max-w-md message-bubble";
                errorBubble.textContent = "Error reaching the brain!";
                chatBox.appendChild(errorBubble);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        function setupSidebarWallpaper() {
            const sidebar = document.getElementById('sidebar');
            const wallpapers = [];
            for (let i = 1; i <= 10; i++) {
                wallpapers.push(`/static/assets/${i}.jpg`);
            }
            let currentIndex = 0;
            sidebar.style.backgroundImage = `url('${wallpapers[currentIndex]}')`;
            setInterval(() => {
                currentIndex = (currentIndex + 1) % wallpapers.length;
                sidebar.style.backgroundImage = `url('${wallpapers[currentIndex]}')`;
            }, 5000);
        }

        function startCountdown(duration, prefix) {
            return new Promise(resolve => {
                let remaining = duration;
                const textEl = document.getElementById('breathing-text');

                const update = () => {
                    textEl.textContent = `${prefix} (${remaining}s)`;
                    remaining--;
                    if (remaining < 0) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                        resolve();
                    }
                };
                update();
                countdownInterval = setInterval(update, 1000);
            });
        }

        async function toggleBreathingExercise() {
            const container = document.getElementById('breathing-container');
            const text = document.getElementById('breathing-text');
            const button = document.getElementById('breathing-button');

            if (mainBreathingLoop) {
                // Stop the exercise
                clearInterval(mainBreathingLoop);
                mainBreathingLoop = null;
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                container.classList.remove('breathing');
                text.textContent = 'Click below to begin.';
                button.textContent = 'Start 4-7-8 Breath';
            } else {
                // Start the exercise
                button.textContent = 'Stop Breathing';
                container.classList.add('breathing');
                
                mainBreathingLoop = setInterval(() => {}, 19000);

                const cycle = async () => {
                    if (!mainBreathingLoop) return;
                    await startCountdown(4, 'Breathe In');
                    if (!mainBreathingLoop) return;
                    await startCountdown(7, 'Hold');
                    if (!mainBreathingLoop) return;
                    await startCountdown(8, 'Breathe Out');
                    if (mainBreathingLoop) {
                        cycle();
                    }
                };
                
                setTimeout(() => {
                    if (mainBreathingLoop) {
                        cycle();
                    }
                }, 1000);
            }
        }

        function setupSidebarToggle() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const burgerMenu = document.getElementById('burger-menu');

            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            };

            burgerMenu.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
        }

        document.getElementById("chat-input").addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        window.onload = () => {
            setupSidebarWallpaper();
            setupSidebarToggle();
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = '';
            musicRecommended = false;
            setTimeout(showGreeting, 2000);
        };
    </script>
</body>

</html>
