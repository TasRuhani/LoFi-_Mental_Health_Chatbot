<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mental Health Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Style for the backgrounds -->
  <style>
    .chat-bg {
      background-image: linear-gradient(rgba(17, 24, 39, 0.8), rgba(17, 24, 39, 0.8)), url('/static/assets/doodle.png');
      background-repeat: repeat;
    }
    #sidebar {
      background-size: cover;
      background-position: center;
      transition: background-image 1.5s ease-in-out;
      /* --- New Border Styles --- */
      border-right: 1px solid rgba(72, 211, 236, 0.2); 
      box-shadow: 4px 0px 15px -3px rgba(72, 230, 236, 0.3); 
    }
    /* --- Styles for Breathing Exercise --- */
    #breathing-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      position: relative;
      background-color: rgba(72, 230, 236, 0.3);
    }

    /* New animation keyframes for a pulsing glow effect */
    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(72, 230, 236, 0.4);
      }
      21% { /* End of 4s inhale */
        transform: scale(1.5);
        box-shadow: 0 0 20px 10px rgba(72, 230, 236, 0);
      }
      58% { /* End of 7s hold */
        transform: scale(1.5);
      }
      100% { /* End of 8s exhale */
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(72, 230, 236, 0.4);
      }
    }

    /* Class to apply the animation */
    .breathing {
      animation: pulse 19s infinite ease-in-out;
    }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-white bg-gray-100 text-gray-900 flex">

  <!-- Sidebar with a new ID for the background effect -->
  <div id="sidebar" class="w-1/4 shadow-md h-screen relative">
    <!-- Overlay to keep text readable -->
    <div class="absolute inset-0 bg-gray-800 bg-opacity-60"></div>
    <!-- Changed flex container to push items to top and bottom -->
    <div class="absolute inset-0 flex flex-col items-center justify-between p-8">
      
      <!-- Top Section: Lofi Player -->
      <div class="text-center">
        <img src="/static/assets/lofi_girl.gif" alt="Lofi Girl"
             class="w-32 h-32 rounded-full object-cover shadow-lg border-4 border-pink-400 dark:border-pink-300 mb-4 mx-auto" />
        <audio id="audio-player" loop></audio>
        <div class="space-y-4">
            <div class="flex justify-center gap-5 py-2 w-full max-w-xs">
              <button onclick="setTrack('chill')" class="bg-blue-500 text-white py-2 px-10 rounded hover:bg-blue-600">Chill</button>
              <button onclick="setTrack('mellow')" class="bg-purple-500 text-white px-10 py-2 rounded hover:bg-purple-600">Mellow</button>
              <button onclick="setTrack('happy')" class="bg-yellow-500 text-white py-2 px-10 rounded hover:bg-yellow-600">Happy</button>
            </div>
            <button onclick="togglePlay()" class="bg-pink-500 text-white px-6 py-2 rounded shadow hover:bg-pink-600 transition">
              Play / Pause
            </button>
        </div>
      </div>

      <!-- Bottom Section: Breathing Exercise -->
      <div class="text-center">
        <div id="breathing-container" class="mx-auto my-6 rounded-full overflow-hidden">
          <img id="breathing-gif" src="/static/assets/cat.gif" alt="Breathing cat" class="w-full h-full object-cover">
        </div>
        <p id="breathing-text" class="text-sm text-gray-300 h-4 mt-2">Click below to begin.</p>
        <button id="breathing-button" onclick="toggleBreathingExercise()" class="mt-3 bg-cyan-700 text-white px-6 py-2 rounded shadow hover:bg-cyan-800 transition text-sm">
          Start 4-7-8 Breathing
        </button>
      </div>

    </div>
  </div>

  <!-- Chat Area with new background class -->
  <div class="flex-1 h-screen flex flex-col p-6 space-y-4 chat-bg">
    <!-- New Chat Button Header -->
    <div class="flex justify-between items-center border-b border-gray-700 pb-2">
        <h1 class="text-xl font-bold">Mental Health Chatbot</h1>
        <button onclick="newChat()" class="bg-blue-500 text-white px-4 py-1 rounded shadow hover:bg-blue-900 transition text-sm">
          New Chat
        </button>
    </div>
    <div id="chat-box" class="flex flex-col space-y-4 overflow-y-auto flex-1"></div>
    
    <!-- Input area with Send Button -->
    <div class="flex items-center p-1 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800 w-full">
        <input id="chat-input" type="text" placeholder="Say something..."
               class="flex-grow bg-transparent focus:outline-none p-3" />
        <button onclick="sendMessage()" class="ml-2 p-2 text-pink-500 hover:text-pink-400 rounded-full hover:bg-gray-700 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
    </div>
  </div>

  <!-- Script -->
  <script>
    const audio = document.getElementById("audio-player");
    let musicRecommended = false;
    let breathingInterval = null; // To hold the timer for the breathing text

    function togglePlay() {
      if (audio.paused) audio.play();
      else audio.pause();
    }

    function setTrack(mood) {
      const tracks = {
        chill: "/static/assets/chill.mp3",
        mellow: "/static/assets/mellow.mp3",
        happy: "/static/assets/happy.mp3"
      };
      if (tracks[mood]) {
        audio.src = tracks[mood];
        audio.play();
      }
    }

    function newChat() {
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = '';
        musicRecommended = false;

        const greeting = document.createElement("div");
        greeting.className = "self-start bg-cyan-700 text-white p-3 rounded-lg max-w-md";
        greeting.textContent = "Hey! How are you feeling today?";
        chatBox.appendChild(greeting);
    }

    async function sendMessage() {
      const input = document.getElementById("chat-input");
      const chatBox = document.getElementById("chat-box");
      const message = input.value.trim();
      if (!message) return;

      const userBubble = document.createElement("div");
      userBubble.className = "self-end bg-blue-500 text-white p-3 rounded-lg max-w-md";
      userBubble.textContent = message;
      chatBox.appendChild(userBubble);
      input.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, music_recommended: musicRecommended })
        });
        const data = await res.json();

        const botBubble = document.createElement("div");
        botBubble.className = "self-start bg-cyan-700 text-white p-3 rounded-lg max-w-md whitespace-pre-line";
        botBubble.textContent = data.reply;
        chatBox.appendChild(botBubble);
        chatBox.scrollTop = chatBox.scrollHeight;

        if (data.mood) {
            musicRecommended = true;
            setTimeout(() => {
              const musicBubble = document.createElement("div");
              musicBubble.className = "self-start bg-pink-500 text-white p-3 rounded-lg max-w-md";
              musicBubble.innerHTML = `ðŸŽ§ You might enjoy some <i>${data.mood}</i> vibes right now.`;
              chatBox.appendChild(musicBubble);
              chatBox.scrollTop = chatBox.scrollHeight;
              setTrack(data.mood);
            }, 700);
        }

      } catch (err) {
        const errorBubble = document.createElement("div");
        errorBubble.className = "self-start bg-red-400 text-white p-3 rounded-lg max-w-md";
        errorBubble.textContent = "Error reaching the brain!";
        chatBox.appendChild(errorBubble);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    function setupSidebarWallpaper() {
        const sidebar = document.getElementById('sidebar');
        const wallpapers = [];
        for (let i = 1; i <= 10; i++) {
            wallpapers.push(`/static/assets/${i}.jpg`);
        }
        
        let currentIndex = 0;
        sidebar.style.backgroundImage = `url('${wallpapers[currentIndex]}')`;

        setInterval(() => {
            currentIndex = (currentIndex + 1) % wallpapers.length;
            sidebar.style.backgroundImage = `url('${wallpapers[currentIndex]}')`;
        }, 5000);
    }
    
    function toggleBreathingExercise() {
        const container = document.getElementById('breathing-container');
        const text = document.getElementById('breathing-text');
        const button = document.getElementById('breathing-button');

        if (breathingInterval) {
            // Stop the exercise
            clearInterval(breathingInterval);
            breathingInterval = null;
            container.classList.remove('breathing');
            text.textContent = 'Click below to begin.';
            button.textContent = 'Start 4-7-8 Breath';
        } else {
            // Start the exercise
            button.textContent = 'Stop Breathing';
            text.textContent = 'Get Ready...';

            setTimeout(() => {
                container.classList.add('breathing');
                
                const updateText = () => {
                    text.textContent = 'Breathe In (4s)';
                    setTimeout(() => {
                        text.textContent = 'Hold (7s)';
                    }, 4000);
                    setTimeout(() => {
                        text.textContent = 'Breathe Out (8s)';
                    }, 11000); // 4s + 7s
                };

                updateText(); // Initial run
                breathingInterval = setInterval(updateText, 19000);
            }, 1000); // 1s "Get Ready" time
        }
    }

    document.getElementById("chat-input").addEventListener("keydown", function (e) {
      if (e.key === "Enter") sendMessage();
    });

    window.onload = () => {
        newChat();
        setupSidebarWallpaper();
    };
  </script>
</body>
</html>
